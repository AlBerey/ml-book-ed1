name: Deploy Jupyter Book to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-pages.txt
      
      - name: Clean previous builds
        run: |
          rm -rf _build
          rm -rf textbook/_build

      - name: Build the book
        run: |
          jupyter-book build textbook

      - name: Show Jupyter Book logs if build fails
        if: failure()
        run: |
          echo "=== _build directory ==="
          ls -ლა _build || true
          echo "=== _build/logs directory ==="
          ls -la _build/logs || true
          echo "=== Printing logs (if any) ==="
          for f in _build/logs/*; do
            echo "----- $f -----"
            tail -n 200 "$f" || true
          done


      - name: Debug build output
        run: |
          echo "Root build folder:"
          ls -la _build || true
          echo "Root HTML folder:"
          ls -la _build/html || true
          echo "Build folder:"
          ls -la textbook/_build || true
          echo "HTML folder:"
          ls -la textbook/_build/html || true
          find textbook -maxdepth 4 -type d -name html -print || true

      - name: Prepare Pages artifact
        run: |
          mkdir -p _site
      
          if [ -d "textbook/_build/html" ]; then
            echo "Using textbook/_build/html"
            cp -r textbook/_build/html/* _site/
          elif [ -d "_build/html" ]; then
            echo "Using _build/html"
            cp -r _build/html/* _site/
          else
            echo "ERROR: Could not find built HTML."
            echo "Listing possible build directories:"
            ls -la
            ls -la _build || true
            ls -la textbook || true
            find . -maxdepth 4 -type d -name html -print || true
            exit 1
          fi
      
          touch _site/.nojekyll


  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
